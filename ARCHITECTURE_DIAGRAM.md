# 360° РАБОТА - Диаграмма Архитектуры

## 🏗️ Общая Архитектура Системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                        360° РАБОТА PLATFORM                         │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│   📱 MOBILE APP  │     │  💻 WEB DASHBOARD│     │  🌐 PUBLIC WEB   │
│  React Native    │     │    Next.js 14    │     │   (Future)       │
│  iOS + Android   │     │  (Employers)     │     │                  │
└────────┬─────────┘     └────────┬─────────┘     └────────┬─────────┘
         │                        │                        │
         │                        │                        │
         └────────────────────────┼────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │   🔧 BACKEND API        │
                    │   Node.js + Express     │
                    │   TypeScript            │
                    │   Port: 3000            │
                    └────────┬────────────────┘
                             │
                ┌────────────┼────────────┐
                │            │            │
                ▼            ▼            ▼
         ┌───────────┐ ┌──────────┐ ┌──────────┐
         │ PostgreSQL│ │  Redis   │ │ External │
         │  Database │ │  Cache   │ │ Services │
         │  + Prisma │ │          │ │          │
         └───────────┘ └──────────┘ └──────────┘
```

---

## 📱 Мобильное Приложение - Детальная Структура

```
┌─────────────────────────────────────────────────────────────────┐
│                    MOBILE APPLICATION LAYERS                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  UI LAYER (Screens & Components)                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ JobSeeker UI │  │ Employer UI  │  │  Admin UI    │          │
│  │              │  │              │  │              │          │
│  │ - Feed       │  │ - Dashboard  │  │ - Users Mgmt │          │
│  │ - Search     │  │ - Vacancies  │  │ - Moderation │          │
│  │ - Profile    │  │ - Candidates │  │ - Analytics  │          │
│  │ - Video      │  │ - Analytics  │  │ - Billing    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  NAVIGATION LAYER (React Navigation)                            │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  RootNavigator                                           │  │
│  │  ├── AuthNavigator (Stack)                               │  │
│  │  ├── JobSeekerNavigator (Bottom Tabs)                    │  │
│  │  ├── EmployerNavigator (Bottom Tabs)                     │  │
│  │  └── AdminNavigator (Bottom Tabs)                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  STATE MANAGEMENT (Zustand Stores)                              │
├─────────────────────────────────────────────────────────────────┤
│  authStore │ chatStore │ applicationsStore │ favoritesStore     │
│  notificationsStore │ settingsStore │ toastStore               │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  SERVICES LAYER                                                  │
├─────────────────────────────────────────────────────────────────┤
│  API Service │ WebSocket │ Video Upload │ Notifications         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  UTILS & HELPERS                                                 │
├─────────────────────────────────────────────────────────────────┤
│  SecureStorage │ Validation │ Haptics │ Platform Detection      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 Бэкенд API - Детальная Структура

```
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND API ARCHITECTURE                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  HTTP SERVER (Express.js)                                        │
│  ├── CORS Middleware                                             │
│  ├── Helmet (Security Headers)                                   │
│  ├── Rate Limiter                                                │
│  └── JSON Body Parser                                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────┴──────────────────────────────────────┐
│  ROUTES LAYER                                                    │
├─────────────────────────────────────────────────────────────────┤
│  /api/auth        - Authentication & Registration                │
│  /api/users       - User Profile Management                      │
│  /api/vacancies   - Vacancy CRUD                                 │
│  /api/applications- Application Management                       │
│  /api/videos      - Video Upload & Management                    │
│  /api/chat        - Real-time Messaging                          │
│  /api/billing     - Wallet & Transactions                        │
│  /api/admin       - Admin Operations                             │
│  /api/analytics   - Analytics & Reporting                        │
│  /api/moderation  - Video Moderation                             │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────┴──────────────────────────────────────┐
│  MIDDLEWARE LAYER                                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐          │
│  │ Auth Guard  │  │ Validation   │  │ Error Handler │          │
│  │ (JWT)       │  │ (Joi/Zod)    │  │               │          │
│  └─────────────┘  └──────────────┘  └───────────────┘          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────┴──────────────────────────────────────┐
│  CONTROLLERS LAYER (Business Logic)                             │
├─────────────────────────────────────────────────────────────────┤
│  AuthController │ VacancyVideoController │ BillingController    │
│  ApplicationController │ ChatController │ AdminController       │
│  ModerationController │ GuestAnalyticsController               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────┴──────────────────────────────────────┐
│  SERVICES LAYER                                                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                    │
│  │ DatabaseService  │  │  VideoService    │                    │
│  │ - Supabase       │  │  - api.video     │                    │
│  │ - VK Cloud       │  │  - Yandex Cloud  │                    │
│  │ - Yandex         │  │  - Private URLs  │                    │
│  │ - Local PG       │  └──────────────────┘                    │
│  └──────────────────┘                                           │
│                                                                  │
│  ┌──────────────────┐  ┌──────────────────┐                    │
│  │ PaymentService   │  │  SMSService      │                    │
│  │ - Alfabank       │  │  - SMS.ru        │                    │
│  └──────────────────┘  └──────────────────┘                    │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────┴──────────────────────────────────────┐
│  DATA LAYER (Prisma ORM + PostgreSQL)                           │
├─────────────────────────────────────────────────────────────────┤
│  User │ Video │ Vacancy │ Resume │ Application │ ChatMessage   │
│  Wallet │ Transaction │ Notification │ Analytics                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🗄️ База Данных - ER Диаграмма

```
┌─────────────────────────────────────────────────────────────────┐
│                   DATABASE ENTITY RELATIONSHIPS                 │
└─────────────────────────────────────────────────────────────────┘

         ┌──────────────────┐
         │      User        │
         │ ================ │
         │ id (PK)          │
         │ phone (unique)   │◄─────────┐
         │ role             │          │
         │ name, email      │          │
         │ balance          │          │
         └────┬─────────────┘          │
              │                        │
      ┌───────┼───────────┐            │
      │       │           │            │
      ▼       ▼           ▼            │
┌─────────┐ ┌───────┐ ┌────────┐      │
│ Vacancy │ │Resume │ │ Video  │      │
│=========│ │=======│ │========│      │
│ id (PK) │ │id (PK)│ │id (PK) │      │
│ title   │ │title  │ │videoId │      │
│ videoId ├─┤videoId├─►userId  ├──────┘
│ salary  │ │       │ │type    │
└────┬────┘ └───┬───┘ │status  │
     │          │     │isPublic│
     │          │     └────────┘
     │          │
     │          └──────────┐
     │                     │
     ▼                     ▼
┌────────────────────────────────────┐
│         Application                │
│ ================================== │
│ id (PK)                            │
│ vacancyId (FK) ──► Vacancy         │
│ jobseekerId (FK) ──► User          │
│ resumeId (FK) ──────► Resume       │
│ resumeVideoId                      │
│ status                             │
│ chatRoomId                         │
└─────────┬──────────────────────────┘
          │
          ├────────────────┬────────────────┐
          ▼                ▼                ▼
   ┌────────────┐  ┌─────────────┐  ┌─────────────┐
   │ChatMessage │  │ResumeVideo  │  │   Favorite  │
   │============│  │View         │  │=============│
   │id (PK)     │  │=============│  │id (PK)      │
   │app...Id(FK)│  │id (PK)      │  │userId       │
   │senderId(FK)│  │videoId (FK) │  │vacancyId(FK)│
   │content     │  │viewCount    │  └─────────────┘
   │videoId     │  │maxViews: 2  │
   └────────────┘  └─────────────┘

         ┌──────────────────┐
         │     Wallet       │
         │ ================ │
         │ id (PK)          │
         │ employerId (FK)  │──► User
         │ balance          │
         └────┬─────────────┘
              │
              ▼
      ┌───────────────┐
      │  Transaction  │
      │ ============= │
      │ id (PK)       │
      │ walletId (FK) │
      │ type          │
      │ amount        │
      │ status        │
      └───────────────┘
```

---

## 🔄 Поток Данных - Основные Сценарии

### Сценарий 1: Регистрация и Вход

```
┌──────────┐     ┌─────────┐     ┌──────────┐     ┌────────────┐
│  Mobile  │────►│ Backend │────►│   SMS    │────►│    User    │
│   App    │     │   API   │     │ Service  │     │   Phone    │
└────┬─────┘     └────┬────┘     └──────────┘     └─────┬──────┘
     │                │                                   │
     │  1. Send Code  │                                   │
     │───────────────►│ 2. Generate & Send SMS           │
     │                │──────────────────────────────────►│
     │                │                                   │
     │  3. Enter Code │◄──────────────────────────────── │
     │───────────────►│ 4. Verify Code                   │
     │                │    & Create JWT                   │
     │◄───────────────│ 5. Return Tokens                 │
     │  Access Token  │                                   │
     │  Refresh Token │                                   │
     └────────────────┘                                   │
```

### Сценарий 2: Создание Вакансии с Видео

```
┌──────────┐     ┌─────────┐     ┌───────────┐     ┌──────────┐
│Employer  │────►│ Backend │────►│ api.video │────►│PostgreSQL│
│   App    │     │   API   │     │  Service  │     │ Database │
└────┬─────┘     └────┬────┘     └─────┬─────┘     └────┬─────┘
     │                │                 │                │
     │ 1. Upload Video│                 │                │
     │───────────────►│ 2. Request      │                │
     │                │   Upload Token  │                │
     │                │────────────────►│                │
     │                │◄────────────────│                │
     │◄───────────────│ 3. Upload URL   │                │
     │                │                 │                │
     │ 4. Upload File │                 │                │
     │────────────────────────────────► │                │
     │                │                 │                │
     │                │◄────────────────│ 5. Webhook     │
     │                │   (Transcoding  │   Callback     │
     │                │    Complete)    │                │
     │                │                 │                │
     │ 6. Create      │                 │                │
     │    Vacancy     │                 │                │
     │───────────────►│ 7. Save to DB   │                │
     │                │────────────────────────────────► │
     │◄───────────────│ 8. Return Vacancy                │
     └────────────────┘                 │                │
```

### Сценарий 3: Отклик на Вакансию с Приватным Видео-Резюме

```
┌──────────┐     ┌─────────┐     ┌──────────┐     ┌───────────┐
│JobSeeker │────►│ Backend │────►│PostgreSQL│────►│ Employer  │
│   App    │     │   API   │     │ Database │     │    App    │
└────┬─────┘     └────┬────┘     └────┬─────┘     └─────┬─────┘
     │                │                │                 │
     │ 1. Apply to    │                │                 │
     │    Vacancy     │                │                 │
     │    + Video     │                │                 │
     │───────────────►│ 2. Create      │                 │
     │                │   Application  │                 │
     │                │───────────────►│                 │
     │                │                │                 │
     │                │ 3. Create      │                 │
     │                │   ResumeVideo  │                 │
     │                │   View Record  │                 │
     │                │   (maxViews:2) │                 │
     │                │───────────────►│                 │
     │                │                │                 │
     │                │                │ 4. Notify       │
     │                │                │   Employer      │
     │                │                │────────────────►│
     │                │                │                 │
     │                │                │ 5. View Video   │
     │                │◄───────────────────────────────  │
     │                │ 6. Check       │                 │
     │                │   viewCount    │                 │
     │                │───────────────►│                 │
     │                │◄───────────────│ (viewCount: 1)  │
     │                │ 7. Return      │                 │
     │                │   Video URL    │                 │
     │                │────────────────────────────────► │
     │                │                │                 │
     │                │                │ 8. View Again   │
     │                │◄───────────────────────────────  │
     │                │ 9. Increment   │                 │
     │                │   viewCount    │                 │
     │                │───────────────►│ (viewCount: 2)  │
     │                │                │                 │
     │                │                │ 10. 3rd Attempt │
     │                │◄───────────────────────────────  │
     │                │ 11. Check      │                 │
     │                │───────────────►│                 │
     │                │◄───────────────│ (LIMIT REACHED) │
     │                │ 12. Return 403 │                 │
     │                │────────────────────────────────► │
     └────────────────┘                │                 │
```

### Сценарий 4: Чат между Работодателем и Соискателем

```
┌──────────┐     ┌─────────┐     ┌──────────┐     ┌──────────┐
│JobSeeker │◄───►│WebSocket│◄───►│ Backend  │◄───►│ Employer │
│   App    │     │ Server  │     │   API    │     │   App    │
└────┬─────┘     └────┬────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1. Connect     │                │                │
     │   to Chat      │                │                │
     │───────────────►│                │                │
     │                │                │ 2. Connect     │
     │                │◄───────────────────────────────  │
     │                │                │                │
     │ 3. Send Message│                │                │
     │───────────────►│ 4. Save to DB  │                │
     │                │───────────────►│                │
     │                │                │                │
     │                │ 5. Broadcast   │                │
     │                │────────────────────────────────► │
     │                │                │                │
     │                │                │ 6. Reply       │
     │                │◄───────────────────────────────  │
     │◄───────────────│                │                │
     │ 7. Receive     │                │                │
     └────────────────┘                │                │
```

---

## 🎯 Компонентная Архитектура (Mobile)

```
┌─────────────────────────────────────────────────────────────────┐
│                     COMPONENT HIERARCHY                         │
└─────────────────────────────────────────────────────────────────┘

App.tsx
└── RootNavigator
    ├── AuthStack (if !authenticated)
    │   ├── WelcomeBackScreen
    │   ├── PhoneInputScreen
    │   ├── SMSVerificationScreen
    │   ├── RoleSelectionScreen
    │   └── RegistrationScreen
    │       ├── EmployerRegistrationScreen
    │       └── JobSeekerRegistrationScreen
    │
    ├── JobSeekerNavigator (if role === JOBSEEKER)
    │   ├── Tab: Feed
    │   │   └── VacancyFeedScreen
    │   │       ├── MainFeedHeader
    │   │       ├── VacancyCard
    │   │       │   ├── VideoPlayer
    │   │       │   └── ActionButtons
    │   │       └── FilterModal
    │   │
    │   ├── Tab: Search
    │   │   └── SearchScreen
    │   │       ├── SearchModal
    │   │       └── VacancyCard
    │   │
    │   ├── Tab: Applications
    │   │   └── ApplicationsScreen
    │   │       └── ApplicationCard
    │   │
    │   ├── Tab: Favorites
    │   │   └── FavoritesScreen
    │   │
    │   └── Tab: Profile
    │       └── ProfileScreen
    │           ├── ResumeVideoPlayer
    │           └── CreateResumeScreen
    │
    ├── EmployerNavigator (if role === EMPLOYER)
    │   ├── Tab: Dashboard
    │   │   └── AnalyticsScreen
    │   │       ├── StatCard
    │   │       ├── BarChart
    │   │       ├── PieChart
    │   │       └── MiniLineChart
    │   │
    │   ├── Tab: Vacancies
    │   │   ├── EmployerVacanciesListScreen
    │   │   └── CreateVacancyScreen
    │   │       └── VideoRecordScreen
    │   │
    │   ├── Tab: Candidates
    │   │   └── CandidatesScreen
    │   │       ├── ApplicationCard
    │   │       └── ResumeVideoPlayer
    │   │
    │   ├── Tab: Wallet
    │   │   └── WalletScreen
    │   │       └── TopUpModal
    │   │
    │   └── Tab: Profile
    │       └── EmployerProfileScreen
    │
    └── AdminNavigator (if role === MODERATOR)
        ├── Tab: Dashboard
        │   └── AdminDashboardScreen
        │
        ├── Tab: Users
        │   └── AdminUsersScreen
        │
        ├── Tab: Vacancies
        │   └── AdminVacanciesScreen
        │
        ├── Tab: Moderation
        │   └── ModerationQueueScreen
        │
        └── Tab: Analytics
            └── AdminReportsScreen
```

---

## 🔐 Архитектура Безопасности

```
┌─────────────────────────────────────────────────────────────────┐
│                     SECURITY ARCHITECTURE                       │
└─────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  FRONTEND SECURITY                                            │
├───────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ SecureStorage    │  │ Input Validation │                  │
│  │ - Encrypted      │  │ - Form validate  │                  │
│  │ - JWT Tokens     │  │ - XSS Protection │                  │
│  │ - Credentials    │  └──────────────────┘                  │
│  └──────────────────┘                                         │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  NETWORK SECURITY                                             │
├───────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ HTTPS/TLS        │  │ Rate Limiting    │                  │
│  │ - SSL Pinning    │  │ - Per IP         │                  │
│  │ - Certificate    │  │ - Per User       │                  │
│  └──────────────────┘  └──────────────────┘                  │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  BACKEND SECURITY                                             │
├───────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ Authentication   │  │ Authorization    │                  │
│  │ - JWT + Refresh  │  │ - Role-Based     │                  │
│  │ - SMS 2FA        │  │ - Resource-Based │                  │
│  └──────────────────┘  └──────────────────┘                  │
│                                                               │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ Input Validation │  │ SQL Injection    │                  │
│  │ - Joi Schemas    │  │ - Prisma ORM     │                  │
│  │ - DTO Validation │  │ - Prepared Stmt  │                  │
│  └──────────────────┘  └──────────────────┘                  │
│                                                               │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ Helmet Headers   │  │ CORS Policy      │                  │
│  │ - CSP            │  │ - Whitelist      │                  │
│  │ - XSS Protection │  │ - Credentials    │                  │
│  └──────────────────┘  └──────────────────┘                  │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  DATA SECURITY                                                │
├───────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ Encryption       │  │ Access Control   │                  │
│  │ - At Rest        │  │ - Row Level      │                  │
│  │ - In Transit     │  │ - Video Privacy  │                  │
│  │ - Bcrypt Hashing │  │ - 2-View Limit   │                  │
│  └──────────────────┘  └──────────────────┘                  │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  VIDEO SECURITY                                               │
├───────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ Private URLs     │  │ Download         │                  │
│  │ - Signed URLs    │  │ Protection       │                  │
│  │ - Time Limited   │  │ - DRM            │                  │
│  │ - View Counter   │  │ - Watermark      │                  │
│  └──────────────────┘  └──────────────────┘                  │
│                                                               │
│  ┌──────────────────┐  ┌──────────────────┐                  │
│  │ Moderation       │  │ HMAC Webhook     │                  │
│  │ - AI Check       │  │ Verification     │                  │
│  │ - Manual Review  │  │ - api.video      │                  │
│  └──────────────────┘  └──────────────────┘                  │
└───────────────────────────────────────────────────────────────┘
```

---

## 📊 Масштабируемость и Производительность

```
┌─────────────────────────────────────────────────────────────────┐
│                   SCALABILITY ARCHITECTURE                      │
└─────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  LOAD BALANCING                                               │
│  ┌────────┐   ┌────────┐   ┌────────┐                         │
│  │  LB 1  │───│  LB 2  │───│  LB 3  │                         │
│  └───┬────┘   └───┬────┘   └───┬────┘                         │
└──────┼────────────┼────────────┼───────────────────────────────┘
       │            │            │
┌──────┼────────────┼────────────┼───────────────────────────────┐
│  API SERVERS (Horizontal Scaling)                             │
│  ┌───┴────┐   ┌──┴─────┐   ┌──┴─────┐   ┌─────────┐          │
│  │ Node 1 │   │ Node 2 │   │ Node 3 │...│ Node N  │          │
│  └───┬────┘   └───┬────┘   └───┬────┘   └────┬────┘          │
└──────┼────────────┼────────────┼─────────────┼────────────────┘
       │            │            │             │
┌──────┼────────────┼────────────┼─────────────┼────────────────┐
│  CACHING LAYER                                                │
│  ┌───┴────────────┴────────────┴─────────────┴──────┐         │
│  │          Redis Cluster                            │         │
│  │  - Session Cache                                  │         │
│  │  - Query Cache                                    │         │
│  │  - Rate Limiting                                  │         │
│  └───────────────────────────────────────────────────┘         │
└───────────────────────────────┬───────────────────────────────┘
                                │
┌───────────────────────────────┴───────────────────────────────┐
│  DATABASE LAYER                                               │
│  ┌─────────────────────────────────────────────────┐          │
│  │     PostgreSQL Primary (Write)                  │          │
│  └─────────────┬──────────────┬────────────────────┘          │
│                │              │                                │
│  ┌─────────────┴──┐  ┌───────┴────────┐                       │
│  │ Read Replica 1 │  │ Read Replica 2 │                       │
│  └────────────────┘  └────────────────┘                       │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  CDN & STATIC ASSETS                                          │
│  ┌─────────────────────────────────────────────────┐          │
│  │             CDN (Cloudflare / AWS)              │          │
│  │  - Static files (images, fonts)                 │          │
│  │  - Video streaming (HLS)                        │          │
│  │  - Geo-distributed                              │          │
│  └─────────────────────────────────────────────────┘          │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│  MONITORING & LOGGING                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │   Winston    │  │  Prometheus  │  │    Sentry    │        │
│  │   Logging    │  │   Metrics    │  │ Error Track  │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└───────────────────────────────────────────────────────────────┘
```

---

**Дата создания:** 2025-11-14
**Версия:** 3.0
